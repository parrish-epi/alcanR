---
title: "Creating r packages"
author: "Jared Parrish, PhD"
date: "2025-01-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Developing a personal R package can help you organizing your code efficiently, 
saving time and effort across projects. It promotes reproducibility, enhances 
collaboration through standardized documentation and version control, and 
improves reliability with built-in testing frameworks. It also enables more
efficent code sharing making it a valuable tool for both individual and 
collaborative work. 

Multiple new tools make developing packages easier than ever. This exercise is
based on the tools in R Studio and developed packages. 

This document outlines the basic approch and key points to remember when 
developing your own local R package. 

## Development Steps  

1. Install and load libraries and any needed datasets.  
2. Create a new package directory (using R Studio tools).  
3. Write/update functions.  
4. Document functions and data sets.  
5. Develop and run tests.  
6. Build and check package.  
7. Load package and run package.  


## Step 1: Install and Load   
The two primary packages required are devtools and roxygen2.  

- The **devtools** package in R simplifies the process of developing, testing, and 
maintaining R packages.  
- The **roxygen2** package in R simplifies writing and maintaining documentation 
for R packages. 

Another helpful package is the testthat package.  
- The **testthat** package in R provides a framework for unit testing, allowing you 
to write and run tests to verify that your code works as intended.

Of note: it is recommended that you also install RTools on Window's based 
machines. Technically it is only needed if your package includes C, C++, or 
Fortran code that needs to be compiled. However, on Window's based machines the
final publishing and checking often call for RTools.  

## Step 2: Create new project  
In R Studio create a new project 

File > New Project > New Directory > R Package  
- enter the package name you want and select the directory location.  

This will create the basic infrastructure of an R package and is basically using
the devtools::create() function. In the directory location you'll see the 
following files:  
- Description: This is the Metadata about the package.  
- NAMESPACE: This controls which functions are exported from the package.  
- R/: Directory where R script functions are saved.  
- man/: Directory for the documentation files. 
- data/: Directory will only be created if you specify data dependencies. 
If not, you can create it manually in the folder. 

One additional director should be created "tests/:". This is where the testing
instances will be stored.   

## Step 3: Write fucntions  
Save or write new functions that you want to use in R/: folder in your project
director. This should be one function per file.  

Multiple tags are available when using roxygen2() for documentation. It is 
important to include these tags to support documentation. Some of the key 
tags are specified below:  
- @param: This describes each of the parameters available in the function.  
- @description: This is brief description about the function.   
- @details: This provides a brief description of what the function does.  
- @author: specify the devleoper.  
- @import: What dependencies this function relies on.  
- @return: What the function returns.  
- @export: Critical to include to specify the NAMESPACE.  

Helpful TIP: The "@export" should be placed directly above where the function begins. 
It is also important to remember to use the #' notation for commenting. 

**Data**  
If you need a specalized data set to test your function be sure to add it now. 
Make sure it is a minimal data set and saved in the "data/:" subfolder.

## Step 4: Document functions  
Run the documentation function in devtools to generate the standardized documentation.  

```{r, eval=FALSE, echo=TRUE}
devtools::document()
```

After running, you'll find a .Rd file in the man/: folder. You can open this and 
inspect it, but do not modify it!  

At this point it is also a good idea to look at your "Description" file. When 
the package is developed it only includes the basic information. You'll need 
to update and add in elements that might be missing, such as "suggests" to indicate
your testing pacage and version, and Imports to indicate what other packages your
package depends on.  

Finally, if you added a data set you'll need to document that now as well. To 
do this you'll you can create a text document or simply use R Studio create new
R documentation file and it will generate the general syntax for you.    
For example:

```{r,eval=FALSE,echo=TRUE}
\name{AlcanLink22}
\alias{AlcanLink22}
\docType{data}
\title{
ALCANLINK22 DATASET
}
\description{
  This dataset contains an extract from the linked ALCANLink data for calculating the
  incidence proportion.
}
\usage{data("AlcanLink22")}
\format{
  A data frame with 11463 observations on the following 13 variables.
  \describe{
    \item{\code{ID}}{a character vector}
    \item{\code{NEST_YR}}{a numeric vector}
    \item{\code{TOTCNT}}{a numeric vector}
    \item{\code{SAMCNT}}{a numeric vector}
    \item{\code{WTANAL}}{a numeric vector}
    \item{\code{STRATUMC}}{a numeric vector}
    \item{\code{SUD_NEST}}{a numeric vector}
    \item{\code{fpc}}{a numeric vector}
    \item{\code{FST_RPT_CensorAge}}{a numeric vector}
    \item{\code{FST_RPT_Indicator}}{a numeric vector}
    \item{\code{mchrace3}}{a character vector}
    \item{\code{public_health_region}}{a character vector}
    \item{\code{sex_code}}{a numeric vector}
  }
}
\source{
%%  ~~ R:\SCANlink\ALCANLink\Current linked files ~~
}

\keyword{datasets}
```

## Step 5: Develop test  
This process can be a little tricky. The "testthat()" package helps out a bunch.
If you didn't do it already, you'll need to create a "tests/:" subfolder where
the testing scripts are saved.  

As an example I might have this base code for testing a function I created:

```{r, eval=FALSE,echo=TRUE}
#test-svyIncProp.R
testthat::test_that("SvyIncProp runs correctly", {
  # Load necessary data
  load(system.file("data", "AlcanLink22.rda", package = "alcanR"))
  t1 <- svydesign(id=~1,strata=~SUD_NEST,fpc=~fpc,weights=~WTANAL,data=AlcanLink22)
  #source("C:\\Users\\jwparrish\\Documents\\alcanR\\R\\SvyIncProp.R")

  # Run the function
  frpt_IP <- SvyIncProp(
    SurveyDesign = t1,
    event = "FST_RPT_Indicator",
    eventime = "FST_RPT_CensorAge",
    nreps = 20
  )

  # Check if the output is a data frame
  testthat::expect_true(is.data.frame(frpt_IP), info = "Output should be a data frame")

  # Additional checks: Ensure specific columns exist
  testthat::expect_true(all(c("theta", "empirical.mean") %in% names(frpt_IP)),
                        info = "Output should contain expected columns")

  # Check the number of rows (if expected)
  testthat::expect_gt(nrow(frpt_IP), 0, info = "Data frame should not be empty")

})
```

Remember, when testing, the load_all() function ensures that that my functions are loaded. If it isn't 
working it is due to an issue with your NAMESPACE. The test() function runs to
check if the output returns the expectation.  

## Step 6: Build and check package  
This step on Windows generally requires RTools. The two functions are:  
- devtools::check()  
- devtools::build()  

After a series of checks, informative messages will be provided to help you
troubleshoot any necessary issues.  

## Step 7: Load packages  
Now that you have a package you can share your functions at a tar.gz file. To 
load you'd run:

```{r,eval=FALSE, echo=TRUE}
install.packages("C:\\Users\\jwparrish\\Documents\\alcanR_0.1.0.tar.gz")
```

**END**

 
